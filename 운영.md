# 운영 가이드

## 배포 구조

```
GitHub (main 브랜치)
    ↓ git push
Render.com (자동 배포)
    ↓ build.sh 실행
    ↓ uvicorn 서버 기동
https://korea-swim-api.onrender.com
```

**배포 트리거**: `main` 브랜치에 push하면 Render가 자동으로 감지하여 빌드 & 배포

---

## Render 서비스 정보

| 항목 | 값 |
|---|---|
| 서비스명 | `korea-swim-api` |
| 타입 | Web Service |
| 런타임 | Python |
| 리전 | Singapore |
| 플랜 | Free |
| 브랜치 | `main` |
| 헬스체크 | `/health` |
| 포트 | 10000 |

### 설정 파일: `render.yaml`
```yaml
services:
  - type: web
    name: korea-swim-api
    runtime: python
    region: singapore
    plan: free
    branch: main
    buildCommand: ./build.sh
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port 10000
    healthCheckPath: /health
    envVars:
      - key: PYTHONUNBUFFERED
        value: "1"
```

### Free 플랜 제약사항
- 15분 무활동 시 서버 슬립 (첫 요청 시 ~30초 콜드스타트)
- 월 750시간 무료
- 512MB RAM, 0.1 CPU
- 커스텀 도메인 미지원 (`.onrender.com` 서브도메인만)

---

## 도메인

| 환경 | URL |
|---|---|
| 프로덕션 | `https://korea-swim-api.onrender.com` |
| 프론트엔드 | `https://korea-swim-api.onrender.com/` (FastAPI에서 서빙) |
| API 문서 | `https://korea-swim-api.onrender.com/docs` |
| 헬스체크 | `https://korea-swim-api.onrender.com/health` |
| 로컬 개발 | `http://localhost:8000` |

프론트엔드는 별도 호스팅 없이 FastAPI가 정적 파일로 직접 서빙:
- `/` → `frontend/index_refactored.html`
- `/css/*`, `/js/*`, `/data/*` → `frontend/` 하위 정적 파일

---

## 데이터베이스

### 로컬 DB vs 배포 DB

```
[로컬 PC]                              [Render 서버]
G:\ai_coding\korea_swim\               /opt/render/project/src/
  swimming_pools.db                       swimming_pools.db
  - 319건, ~450KB                         - 배포할 때마다 새로 생성됨
  - enrichment 완료 (303건 success)       - advanced_pools.json 기준으로만 생성
  - git에 포함 안 됨 (.gitignore)         - enrichment 데이터 없음
  - 수동으로 지우지 않는 한 유지됨
```

| 항목 | 로컬 DB | 배포 DB |
|---|---|---|
| 경로 | `G:\ai_coding\korea_swim\swimming_pools.db` | Render 인스턴스 내 |
| 삭제 여부 | **안 지워짐** (내 PC 파일) | **배포마다 초기화** |
| enrichment 데이터 | 있음 (303건) | **없음** |
| Git 추적 | X (`.gitignore`에 `*.db`) | X (빌드 시 생성) |

### 빌드 시 DB 생성 흐름 (build.sh)

```
build.sh
  ↓
pip install -r requirements.txt
  ↓
python scripts/process_pools.py
  → advanced_pools.json 읽기 → 필터링 → final_pools.json 덮어쓰기
  ↓
python load_data_to_db.py final_pools.json
  → final_pools.json → swimming_pools.db 생성 (upsert)
```

**핵심**: `process_pools.py`가 `advanced_pools.json`에서 `final_pools.json`을 **매번 새로 생성**한다.
따라서 `final_pools.json`을 커밋해도 빌드 시 덮어써지므로 의미 없음.

### enrichment 데이터가 배포에 반영되지 않는 이유

1. `llm_enricher.py`는 **로컬 DB에 직접 UPDATE**함 (JSON 파일 수정 아님)
2. 배포 시 `build.sh`는 `advanced_pools.json` → `final_pools.json` → DB 순서로 생성
3. `advanced_pools.json`에는 enrichment 필드(pricing, operating_hours 등)가 없음
4. 결과: 배포 DB에는 enrichment 데이터가 포함되지 않음

### enrichment 데이터를 배포에 반영하는 방법

`scripts/export_enrichment.py`가 로컬 DB → `advanced_pools.json` 머지를 수행한다.

```bash
# 1. 로컬에서 enrichment 실행 (필요 시)
python crawler/llm_enricher.py

# 2. DB의 enrichment 결과를 advanced_pools.json에 머지
python scripts/export_enrichment.py

# 3. 커밋 & push → Render 자동 배포
git add advanced_pools.json
git commit -m "data: enrichment 데이터 반영"
git push origin main
```

**흐름 요약:**
```
로컬 DB (enrichment 완료)
    ↓ export_enrichment.py
advanced_pools.json (enrichment 필드 머지됨)
    ↓ git push
Render build.sh
    ↓ process_pools.py (필터링)
final_pools.json
    ↓ load_data_to_db.py
배포 DB (enrichment 데이터 포함)
```

### DB 스키마 (주요 컬럼)

| 컬럼 | 타입 | 설명 | enrichment 대상 |
|---|---|---|---|
| id | INTEGER | PK | |
| name | VARCHAR | 수영장 이름 | |
| address | VARCHAR | 주소 | |
| lat, lng | FLOAT | 좌표 | |
| phone | VARCHAR | 전화번호 | O |
| pricing | JSON | 가격 정보 (일일권/자유수영/강습) | O |
| free_swim_schedule | JSON | 요일별 자유수영 시간표 | O |
| operating_hours | JSON | 요일별 운영시간 | O |
| lanes | INTEGER | 레인 수 | O |
| pool_size | VARCHAR | 수영장 규격 | O |
| facilities | JSON | 시설 목록 | |
| parking | BOOLEAN | 주차 가능 여부 | O |
| notes | TEXT | 비고 | O |
| enrichment_status | TEXT | LLM 추출 상태 (success/failed/pending) | |

---

## 환경변수

| 변수 | 위치 | 용도 | 필수 |
|---|---|---|---|
| `PYTHONUNBUFFERED` | Render | 로그 즉시 출력 | O (render.yaml에 설정됨) |
| `DATABASE_URL` | Render / .env | DB 경로 (기본: sqlite:///./swimming_pools.db) | X |
| `ANTHROPIC_API_KEY` | 로컬 .env | LLM enricher용 Claude API | 로컬만 |
| `NAVER_CLIENT_ID` | 로컬 .env | 크롤러 네이버 검색 API | 로컬만 |
| `NAVER_CLIENT_SECRET` | 로컬 .env | 크롤러 네이버 검색 API | 로컬만 |

---

## 배포 방법

### 코드 변경만 있을 때
```bash
git add <변경 파일>
git commit -m "feat: 설명"
git push origin main
# → Render 자동 배포 (2~3분 소요)
```

### 수동 배포 (Render 대시보드)
1. https://dashboard.render.com 접속
2. `korea-swim-api` 서비스 선택
3. "Manual Deploy" → "Deploy latest commit"

---

## 로컬 개발

```bash
# 서버 실행
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 브라우저에서 확인
# http://localhost:8000        (프론트엔드)
# http://localhost:8000/docs   (API 문서)
# http://localhost:8000/health (헬스체크)
```

---

## API 엔드포인트

| 메서드 | 경로 | 설명 |
|---|---|---|
| GET | `/` | 프론트엔드 메인 페이지 |
| GET | `/health` | 헬스체크 |
| GET | `/docs` | Swagger API 문서 |
| GET | `/api/pools` | 수영장 목록 (필터링) |
| GET | `/api/pools/nearby` | 위치 기반 검색 |
| POST | `/api/pools/search` | 위치 기반 검색 (POST) |
| POST | `/api/pools` | 수영장 추가 |

### 주요 쿼리 파라미터 (`/api/pools/nearby`)

| 파라미터 | 타입 | 설명 |
|---|---|---|
| lat, lng | float | 중심 좌표 (필수) |
| radius | float | 검색 반경 km (기본 5.0) |
| min_price, max_price | int | 가격 범위 필터 |
| has_free_swim | bool | 자유수영 시간표 보유 필터 |
| day | string | 요일 필터 (월~일) |
| time | string | 시간 필터 (HH:MM) |
| sort | string | 정렬 (price/distance) |

---

## 모니터링

### 서버 상태 확인
```bash
curl https://korea-swim-api.onrender.com/health
# {"status": "healthy"}
```

### Render 대시보드
- 로그: https://dashboard.render.com → 서비스 → Logs
- 메트릭: Events 탭에서 배포 이력 확인

### 알려진 이슈
- **Free 플랜 슬립**: 15분 무활동 시 서버 종료, 첫 요청 시 ~30초 지연
- **SQLite 한계**: 동시 쓰기 불가 (현재 읽기 전용이라 문제 없음)
- **enrichment 데이터 미반영**: 로컬 DB의 enrichment 결과가 배포 DB에 반영되지 않음 (파이프라인 개선 필요)
