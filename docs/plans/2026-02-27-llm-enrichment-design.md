# LLM 기반 데이터 추출 + 앱 개선 디자인

## 배경
- 현재 DB 319건 중 가격 22%, 시간표 12%만 보유
- 가격도 "3400" 단일 숫자 → 대상별/요일별 상세 정보 없음
- 구글 검색이 더 유용한 상태 → 앱의 존재 의미 없음

## 타겟/방향
- **타겟**: 자유수영러
- **범위**: 수도권 (서울 243 + 경기 10 + 인천 8 = 261건)
- **차별화**: 요일별 시간표 + 가격별 + 위치별 복합 검색 (구글 불가 영역)

---

## 1. LLM 데이터 추출 파이프라인

### 추출 흐름
```
DB에서 수영장 URL 조회 (312건)
    ↓
1차: 웹사이트 HTML 크롤링 (requests + BeautifulSoup)
    ↓ (JS 렌더링 실패 또는 정보 부족 시)
2차: 네이버 웹검색 "수영장명 자유수영 가격 시간표"
    ↓
HTML/검색결과 텍스트를 Claude Haiku에 전달
    ↓
구조화된 JSON 반환 (가격표 + 시간표 + 운영시간)
    ↓
검증 후 DB UPDATE
```

### Claude 프롬프트 설계
- 웹페이지 텍스트 전달 → 아래 JSON 스키마에 맞춰 추출 요청
- 정보 없으면 null 반환 (환각 방지)
- temperature=0

### 추출 JSON 스키마
```json
{
  "pricing": {
    "일일권": {
      "성인": {"평일": null, "주말": null},
      "청소년": {"평일": null, "주말": null},
      "어린이": {"평일": null, "주말": null},
      "경로": {"평일": null, "주말": null}
    },
    "자유수영": { "동일 구조" },
    "강습_월": {"성인": null, "청소년": null}
  },
  "free_swim_schedule": {
    "월": ["HH:MM-HH:MM"],
    "화": [], "수": [], "목": [], "금": [], "토": [], "일": [],
    "휴관": "매월 첫째 일요일"
  },
  "operating_hours": {
    "월": "HH:MM-HH:MM", "화": "", "수": "", "목": "", "금": "",
    "토": "HH:MM-HH:MM", "일": "HH:MM-HH:MM"
  },
  "phone": "02-XXX-XXXX",
  "lanes": 8,
  "pool_size": "25m x 6레인",
  "parking": true,
  "notes": "비고 사항"
}
```

### 비용 추정
- 입력: 평균 ~3000 토큰, 출력: ~500 토큰
- 312건 처리: **약 $0.5~1**

### CLI
```bash
python crawler/llm_enricher.py                 # 전체 실행
python crawler/llm_enricher.py --test 5 --dry-run  # 테스트
python crawler/llm_enricher.py --id 42         # 특정 수영장
python crawler/llm_enricher.py --retry-failed  # 실패 재시도
```

---

## 2. DB 스키마 변경

### 삭제 컬럼
- `daily_price` (String) → pricing JSON에 통합
- `free_swim_price` (String) → pricing JSON에 통합
- `monthly_lesson_price` (String) → pricing JSON에 통합
- `free_swim_times` (JSON, 비구조) → free_swim_schedule로 교체
- `membership_prices` (JSON) → pricing에 통합
- `lessons` (JSON) → pricing 강습_월에 통합

### 변경 컬럼
- `operating_hours` (JSON) → 구조 통일 (요일별)

### 추가 컬럼
- `pricing` JSON — 대상별/요일별 상세 가격
- `free_swim_schedule` JSON — 요일별 자유수영 시간표
- `notes` TEXT — 비고 (휴관일, 예약방법 등)
- `parking` BOOLEAN — 주차 가능 여부
- `pool_size` STRING — 유지 (기존)
- `last_enriched` DATETIME — LLM 추출 시점
- `enrichment_status` STRING — success/failed/pending

### pricing JSON 예시
```json
{
  "일일권": {
    "성인": {"평일": 3400, "주말": 4400},
    "청소년": {"평일": 2400, "주말": 3000},
    "어린이": {"평일": 1800, "주말": 2200},
    "경로": {"평일": 2700, "주말": 3500}
  },
  "자유수영": {
    "성인": {"평일": 3400, "주말": 4400}
  },
  "강습_월": {
    "성인": 120000
  }
}
```

### free_swim_schedule JSON 예시
```json
{
  "월": ["12:00-12:50"],
  "화": ["12:00-12:50"],
  "수": ["12:00-12:50"],
  "목": ["12:00-12:50"],
  "금": ["12:00-12:50"],
  "토": ["06:00-07:50", "09:00-10:50", "16:00-17:50"],
  "일": ["09:00-10:50", "13:00-14:50"],
  "휴관": "매월 첫째 일요일"
}
```

### operating_hours JSON 예시 (구조 통일)
```json
{
  "월": "06:00-22:00",
  "화": "06:00-22:00",
  "수": "06:00-22:00",
  "목": "06:00-22:00",
  "금": "06:00-22:00",
  "토": "06:00-18:00",
  "일": "09:00-18:00"
}
```

---

## 3. 프론트엔드 개선

### 검색/필터 UI
현재: [검색바] [전체|공공|민간] [반경] [내 위치]

개선:
```
[검색바 / 위치: 내 위치 / 지하철역 / 주소]
[요일: 월|화|수|목|금|토|일]  [시간대: 오전|오후|저녁]
[가격: ~3000 | ~5000 | ~10000 | 전체]
[정렬: 가격순 | 거리순]
```

### 카드 (목록)
```
┌─────────────────────────────────────┐
│ 1  관악구민체육센터        지금 영업중  │
│    서울 관악구 남부순환로 1906          │
│    📞 02-879-6611                    │
│                                      │
│    💰 자유수영 성인 3,400원 (평일)      │
│    🕐 오늘(토) 06:00 / 09:00 / 16:00 │
│    🏊 25m · 6레인                     │
│                                      │
│    [N] [K] [G]                       │
└─────────────────────────────────────┘
```

### 팝업 (상세)
마커 클릭 시 전체 가격표 + 주간 시간표 표시:
- 운영시간 (요일별)
- 자유수영 가격표 (대상별 x 평일/주말)
- 자유수영 시간표 (요일별)
- 강습 가격 (있을 때만)
- 레인/풀 크기
- 비고 (휴관일, 예약방법 등)

### API 개선
`GET /api/pools/nearby` 필터 파라미터 추가:
```
?lat=37.5&lng=127.0&radius=5
&day=토           // 요일 필터
&time=09:00       // 해당 시간에 자유수영 가능한 곳
&max_price=5000   // 자유수영 최대 가격 (성인 기준)
&sort=price       // 정렬 (price, distance)
```

---

## 4. 구현 순서

### Phase A: LLM 데이터 추출 (핵심)
1. DB 스키마 변경 (마이그레이션 스크립트)
2. `crawler/llm_enricher.py` 구현
3. 테스트 5건 → 전체 실행
4. 데이터 품질 검증

### Phase B: 백엔드 API 개선
5. 스키마/모델/CRUD 업데이트
6. 복합 필터 API 구현

### Phase C: 프론트엔드 개선
7. 필터 UI 구현
8. 카드/팝업 상세 정보 표시
9. "오늘 기준" 자유수영 시간 표시
